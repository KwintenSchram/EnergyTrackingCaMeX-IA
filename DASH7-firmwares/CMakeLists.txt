cmake_minimum_required(VERSION 3.18)

project("EnergyTrackingCamexia")

if(CMAKE_CURRENT_BINARY_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
  set(CMAKE_CURRENT_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/build")
endif()

if(CMAKE_EXTRA_GENERATOR)
    set (GENERATOR "${CMAKE_EXTRA_GENERATOR} - ${CMAKE_GENERATOR}")
else()
    set (GENERATOR "${CMAKE_GENERATOR}")
endif(CMAKE_EXTRA_GENERATOR)

set(SUB_IOT_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/Sub-IoT-Stack/stack")

set(BUILD_ENERGY_OVER_DASH7 "${CMAKE_CURRENT_BINARY_DIR}/Energy-over-DASH7")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_ENERGY_OVER_DASH7})
execute_process(
    WORKING_DIRECTORY ${BUILD_ENERGY_OVER_DASH7}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM_EXTRA_PLATFORMS_DIR=${CMAKE_CURRENT_SOURCE_DIR}/platform
    -D APP_EXTRA_APPS_DIR=${CMAKE_CURRENT_SOURCE_DIR}/app
    -D PLATFORM=LIQUIBUS
    -D APP_ENERGY_OVER_DASH7=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(energy-over-dash7 ALL
    WORKING_DIRECTORY ${BUILD_ENERGY_OVER_DASH7}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j Energy_over_DASH7.elf
)

set(BUILD_IOWAY_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/IOWay-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=IOWAY_gateway
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=0
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-release ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)
